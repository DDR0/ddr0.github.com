<!doctype html>
<html lang=en-CA>
	<head>
		<meta charset=utf-8>
		<title>Reminder</title> <!-- Basically, an auto-Joy. Much worse than the original! <3 -->
		<meta name=viewport content="width=device-width, initial-scale=1, minimum-scale=1">
		<meta name=theme-color content=#BB9>
		
		<style>
			html, body {
				margin: 0;
				color: #014;
				background-color: #BB9;
				min-height: 100vh;
			}
			body {
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
			}
			form {
				max-width: 21rem;
				background-color: #0002;
				margin: 1rem;
				border: 1rem solid #CCA;
				padding: 2rem 4rem;
			}
			input {
				max-width: 4em;
			}
			button {
				padding-left: 1em;
				padding-right: 1em;
			}
			label {
				user-select: none;
			}
			.hidden {
				display: none;
			}
			.error {
				color: darkred;
				&::before {
					content: '⚠️ ';
				}
			}
			[title] {
				cursor: help;
			}
		</style>
		
		<script>
			"use strict";
			
			(async ()=>{
				const registration = await navigator.serviceWorker.register("reminder service worker.mjs");
				if (registration.installing) {
					console.info("Service worker installing");
				} else if (registration.waiting) {
					console.info("Service worker installed");
				} else if (registration.active) {
					console.info("Service worker active");
				}
			})();
			
			addEventListener('push', evt=>console.log('tab: push', evt));
			
			let applicationServerKey;
			const keyFetch = fetch('/side projects/reminder/api/v1/key');
			
			document.addEventListener("DOMContentLoaded", ()=>{
				if (!("Notification" in window)) {
					document.body.innerText = "This browser does not support notifications."
				}
				if (!"serviceWorker" in navigator) {
					document.body.innerText = "This browser does not support service workers, which are needed for reliable notifications."
				}
				
				const $ = document.querySelectorAll.bind(document);
				const [startDesc, stopDesc] = $("p");
				const [prompt, minutes, round] = $("input");
				const [roundingTime] = $("#rounding-time")
				const [startButton, stopButton] = $("button");
				const [error, output] = $("output");
				
				let notificationInterval = -1;
				let clockInterval = -1;
				let startTime = 0;
				
				
				const fatalError = message => {
					stopDesc.setAttribute("class", "hidden");
					startDesc.removeAttribute("class");
					startButton.disabled = true;
					startButton.setAttribute('title', "Can not start due to error.");
					error.innerText = message;
					error.classList.remove('hidden');
				}
				
				keyFetch.then(async response => {
					if (response.ok)
						applicationServerKey = new Uint8Array(await (await response.blob()).arrayBuffer());
					else
				             fatalError("Could not contact push notification server. Service may be down. Contact site admin for help.");
				}).catch(()=>fatalError("Could not contact push notification server. Service may be down. Contact site admin for help."));
				
				navigator.serviceWorker.addEventListener('controllerchange', e => {
					console.info('service worker changed', e);
				});
				
				startButton.addEventListener('click', evt=>{
					evt.preventDefault();
					
					console.log(applicationServerKey);
					
					if(!applicationServerKey) {
						error.innerText = "Waiting on push notification server… please try again in a second…";
						error.classList.remove('hidden');
					} else {
						error.classList.add('hidden');
					}
					
					console.info('starting timer');
					
					
					navigator.serviceWorker.ready.then(registration => {
						registration.active.postMessage({
							action: 'start', 
							payload: {
								prompt: prompt.value,
								minutes: minutes.valueAsNumber,
								round: round.checked,
							},
						});
						
						registration.pushManager.subscribe({
							userVisibleOnly: true,
							applicationServerKey,
						}).then(
							pushSubscription => {
								console.log('pse', pushSubscription);
							},
							error => fatalError(error),
						);
						
					}).catch(err => console.error('could not start', err));
						
					//Set visual state to "running".
					startDesc.setAttribute("class", "hidden");
					stopDesc.removeAttribute("class");
				});
				
				stopButton.addEventListener('click', evt=>{
					evt.preventDefault();
					console.info('stopping timer');
					
					navigator.serviceWorker.ready.then(registration => {
						registration.active.postMessage({ action:"stop" });
					}).catch(err => console.error('could not stop', err));
					
					stopDesc.setAttribute("class", "hidden");
					startDesc.removeAttribute("class");
				});
				
				//If the form is submitted, just trigger the button action instead.
				$('form')[0].addEventListener('submit', ()=>{
					$('p:not(.hidden) button')[0].click();
					evt.preventDefault();
				});
				
				minutes.addEventListener('change', e => roundingTime.innerText = e.target.value);
				roundingTime.innerText = minutes.value
				
				//Update the timer when we're running.
				navigator.serviceWorker.addEventListener("message", ({data: {action, payload}}) => {
					({
						updateRemainingTime: ({time})=>output.innerText = time,
						stop: ()=>{
							confirm("Cancel repeating timer?") && stopButton.click()
						},
						error: ({message="An error occurred. Try reloading?"}) => fatalError(message),
					})[action](payload);
				});
				
				//OK, script ran, we're good to go.
				startButton.disabled = false;
				startButton.removeAttribute('title');
				error.classList.add('hidden');
			});
		</script>
	</head>
	
	<body>
		<form>
			<p>
				Tell me <input name="prompt" value=save> every <input name="duration" type=number value=15 min=0> minutes.<br>
				<label><input name=round type=checkbox> Round alert times to nearest <span id="rounding-time">15</span> minutes.</label><br><br>
				<button disabled title="Can not start due to error.">Go</button> <output class="error">Error loading JS.</output>
			</p>
			<p class=hidden>
				Reminder in <output></output>.<br><br>
				<button>Stop</button>
			</p>
		</form>
	</body>
</html>